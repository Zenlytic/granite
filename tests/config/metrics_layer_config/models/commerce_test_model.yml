version: 1
type: model
name: test_model
label: "Test commerce data"
connection: "connection_name"

access_grants:
  - name: test_access_grant_department_explore
    user_attribute: department
    allowed_values: ["finance", "executive", "marketing"]
  - name: test_access_grant_department_view
    user_attribute: department
    allowed_values: ["finance", "executive", "sales"]
  - name: test_access_grant_department_join
    user_attribute: department
    allowed_values: ["executive"]
  - name: test_access_grant_department_field
    user_attribute: department
    allowed_values: ["executive", "engineering", 'sales']
  - name: test_access_grant_department_dashboard
    user_attribute: department
    allowed_values: ["executive", 'sales']

explores:
  - name: order_lines_all
    from: order_lines
    description: "Description for order lines"
    label: "Description for order lines"
    group_label: "Purchases"
    fields: [ALL_FIELDS*, all_orders*, -orders.test_removal*, -discounts.country]
    required_access_grants: [test_access_grant_department_explore]
    join_for_analysis: [all_orders, customers]

    access_filters:
      - field: customers.region
        user_attribute: owned_region

    joins:
      - name: all_orders
        from: orders
        type: left_outer
        relationship: many_to_one
        sql_on: "${order_lines_all.order_id}=${all_orders.order_id}"

      - name: country_detail
        type: left_outer
        relationship: many_to_one
        sql_on: "${discounts.country}=${country_detail.country_id}"

      - name: customers
        required_access_grants: [test_access_grant_department_join]
        from: customers
        foreign_key: customer_id

      - name: discounts
        type: left_outer
        relationship: one_to_many
        sql_on: "${all_orders.order_id}=${discounts.order_id}"

      - name: discount_detail
        type: left_outer
        relationship: one_to_one
        sql_on: "${discounts.discount_id}=${discount_detail.discount_id} AND ${discounts.order_week} is not null"

  - name: discounts_only
    view_name: discounts

    joins:
      - name: discount_detail
        type: left_outer
        relationship: one_to_many
        sql_on: "${discounts_only.discount_id}=${discount_detail.discount_id}"
